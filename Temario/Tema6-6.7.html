<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tema 6 - Wordpress Docker-compose</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="icon" type="image/x-icon" href="../Assets/favicon.ico">
</head>
<body class="container">
    <nav class="mt-1">
        <ul class="nav justify-content-center">
            <li class="nav-item">
            <a class="nav-link" href="../index.html">Inicio</a>
            </li>
            <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="./Tema1.html">Tema 1</a>
            </li>
            
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Tema 2
                </a>
                <ul class="dropdown-menu">
                    
                  <li><a class="dropdown-item" href="./Tema2.html">Tema 2</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="./Tema2-2.1.html">Practica 2.1</a></li>
                  <li><a class="dropdown-item" href="./Tema2-2.2.html">Practica 2.2</a></li>
                  <li><a class="dropdown-item" href="./Tema2-2.3.html">Practica 2.3</a></li>
                  <li><a class="dropdown-item" href="./Tema2-2.4.html">Practica 2.4</a></li>
                  <li><a class="dropdown-item" href="./Tema2-2.5.html">Practica 2.5</a></li>
                </ul>
            </li>

             
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Tema 3
                </a>
                <ul class="dropdown-menu">
                    
                  <li><a class="dropdown-item" href="#">Tema 3</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="./Tema3-3.1.html">Practica 3.1</a></li>
                  <li><a class="dropdown-item" href="./Tema3-3.2.html">Practica 3.2</a></li>
                  <li><a class="dropdown-item" href="./Tema3-3.3.html">Practica 3.3</a></li>
                </ul>
            </li>

            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Tema 5
                </a>
                <ul class="dropdown-menu">
                    
                  <li><a class="dropdown-item" href="./Tema5.html">Tema 5</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="./Tema5-5.4.html">Uso basico</a></li>
                  <li><a class="dropdown-item" href="./Tema5-5.5.html">Uso avanzado</a></li>
                  <li><a class="dropdown-item" href="./Tema5-5.6.html">Ramas</a></li>
                  <li><a class="dropdown-item" href="./Tema5-5.7.html">Github</a></li>
                  <li><a class="dropdown-item" href="./Tema5-5.8.html">Citar proyectos en Github</a></li>
                  <li><a class="dropdown-item" href="./Tema5-5.9.html">Git Flow</a></li>
                
                </ul>
            </li>

            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Tema 6
                </a>
                <ul class="dropdown-menu">
                    
                  <li><a class="dropdown-item" href="./Tema6.html">Tema 6</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="./Tema6-6.2.html">Instalación</a></li>
                  <li><a class="dropdown-item" href="./Tema6-6.3.html">Images</a></li>
                  <li><a class="dropdown-item" href="./Tema6-6.4.html">Contenedores</a></li>
                  <li><a class="dropdown-item" href="./Tema6-6.5.html">Volumenes</a></li>
                  <li><a class="dropdown-item" href="./Tema6-6.6.html">Wordpress Con Docker</a></li>
                  <li><a class="dropdown-item" href="./Tema6-6.7.html">Wordpress Con Docker-Compose</a></li>

                </ul>
            </li>
        </ul>
    </nav>

<!--content-->
<h1 id="levantar-un-wordpress-con-docker-compose">Levantar un WordPress con Docker Compose</h1>
<p>El cliente de <em>Docker</em> es engorroso para crear contenedores, así como para crear el resto de objetos y vincularlos entre sí.</p>
<p>Para automatizar la creación, inicio y parada de un contenedor o un conjunto de ellos, <em>Docker</em> proporciona una herramiento llamada <em>Docker Compose</em>.</p>
<p>Para esta parte vamos a detener y borrar lo que hemos creado:</p>
<p>!!! example</p>
<pre><code>Borra el trabajo actual:
```sh
docker container stop wordpress wordpress-db
docker container rm wordpress wordpress-db
docker volume rm wordpress-db
```
</code></pre>
<h2 id="docker-compose">Docker Compose</h2>
<p><em>Compose</em> es una herramienta para definir y ejecutar aplicaciones multi-contenedor. Con un solo comando podremos crear e iniciar todos los servicios que necesitamos para nuestra aplicación.</p>
<p>Los casos de uso más habituales para docker-compose son:</p>
<ul>
<li>Entornos de desarrollo</li>
<li>Entornos de testeo automáticos (integración contínua)</li>
<li>Despliegue en host individuales (no clusters)</li>
</ul>
<p><em>Compose</em> tiene comandos para manejar todo el ciclo de vida de nuestra aplicación:</p>
<ul>
<li>Iniciar, detener y rehacer servicios.</li>
<li>Ver el estado de los servicios.</li>
<li>Visualizar los logs.</li>
<li>Ejecutar un comando en un servicio.</li>
</ul>
<h2 id="creación-de-contenedores-automatizada">Creación de contenedores automatizada</h2>
<p>En el mismo directorio donde estábamos en el paso anterior (<code>~/Sites/wordpress</code>), vamos a crear un fichero llamado <code>docker-compose.yaml</code> con el siguiente contenido:</p>
<pre><code class="language-yaml">version: &#39;3&#39;

services:
    db:
        image: mariadb:10.3.9
        volumes:
            - data:/var/lib/mysql
        environment:
            - MYSQL_ROOT_PASSWORD=secret
            - MYSQL_DATABASE=wordpress
            - MYSQL_USER=manager
            - MYSQL_PASSWORD=secret
    web:
        image: wordpress:4.9.8
        depends_on:
            - db
        volumes:
            - ./target:/var/www/html
        environment:
            - WORDPRESS_DB_USER=manager
            - WORDPRESS_DB_PASSWORD=secret
            - WORDPRESS_DB_HOST=db
        ports:
            - 8080:80

volumes:
    data:
</code></pre>
<p>!!! info
    YAML es un lenguaje de serialización de datos diseñado para ser leído y escrito por personas. Se recomienda que sigas algún tutorial para entender su formato: <a href="https://learnxinyminutes.com/docs/es-es/yaml-es/">Aprende YAML en Y minutos</a>.</p>
<p>Los ficheros de <em>Compose</em> están divididos en tres secciones: <em>services</em>, <em>volumes</em> y <em>networks</em>; y deben indicar un número de versión. Nos permite realizar practicamente lo mismo que podemos hacer con el cliente de <em>docker</em>, pero de forma automática.</p>
<p>!!! note
    En este taller no entramos en el apartado de <em>networks</em>.</p>
<p>Con este fichero podemos hacer lo mismo que hemos hecho en el capítulo anterior, pero con la ventaja de describir todos nuestros requisitos en un solo archivo.</p>
<h2 id="iniciar-servicios">Iniciar servicios</h2>
<p>Vamos a ejecutar esta aplicación y luego procederemos a explicarla:</p>
<p>!!! example
    Arranca la aplicación con <em>Compose</em>:</p>
<pre><code>    docker-compose up -d
</code></pre>
<p>Cuando arrancamos la aplicación, <em>Compose</em> nos informa de los servicios que ha ido levantando:</p>
<pre><code class="language-console">$ docker-compose up -d
Creating network &quot;wordpress_default&quot; with the default driver
Creating volume &quot;wordpress_data&quot; with local driver
Creating wordpress_db_1 ... 
Creating wordpress_db_1 ... done
Creating wordpress_web_1 ... 
Creating wordpress_web_1 ... done
</code></pre>
<p>El parámetro <code>-d</code> es similar al que hemos visto en <code>docker run</code>: nos permite levantar los servicios en segundo plano.</p>
<p>Veamos los contenedores activos:</p>
<pre><code class="language-console">$ docker container ls
CONTAINER ID  IMAGE            COMMAND      CREATED         STATUS         PORTS                  NAMES
a07b5d4d3982  wordpress:4.9.8  &quot;docker.s…&quot;  10 seconds ago  Up 8 seconds   0.0.0.0:8080-&gt;80/tcp   wordpress_web_1
d9204884cec5  mariadb:10.3.9   &quot;docker.s…&quot;  11 seconds ago  Up 10 seconds  3306/tcp               wordpress_db_1
</code></pre>
<p>También podemos ver los contenedores con <em>Compose</em>:</p>
<pre><code class="language-console">$ docker-compose ps
    Name                    Command               State          Ports        
-------------------------------------------------------------------------------
wordpress_db_1    docker-entrypoint.sh mysqld      Up      3306/tcp            
wordpress_web_1   docker-entrypoint.sh apach ...   Up      0.0.0.0:8080-&gt;80/tcp
</code></pre>
<p>Lo que tenemos que tener en cuenta es lo siguiente:</p>
<ul>
<li><code>docker-compose ps</code> solo muestra información de los servicios que se define en <code>docker-compose.yaml</code>, mientras que <code>docker</code> muestra todos.</li>
<li>Cuando creamos contenedores con <code>docker</code> sin indicar un nombre, por defecto asigna uno aleatorio; mientras que en <em>Compose</em> el prefijo es el nombre del directorio y el sufijo el nombre del servicio: <em><strong>wordpress</strong>_<strong>db</strong>_1</em>. El número indica el número de instancia. Es posible levantar más de una instancia de un mismo servicio.</li>
</ul>
<p>Si accedemos a la dirección <a href="http://localhost:8080/">http://localhost:8080/</a>, veremos de nuevo la instalación de WordPress.</p>
<h2 id="detener-servicios">Detener servicios</h2>
<p>Podemos detener servicios con</p>
<pre><code>docker-compose stop
</code></pre>
<h2 id="borrar-servicios">Borrar servicios</h2>
<p>Podemos borrar servicios con</p>
<pre><code>docker-compose down
</code></pre>
<p>Esto borra los contenedores, pero no los volúmenes. Así que si hemos creado bien la aplicación nuestros datos están a salvo.</p>
<p>Si queremos borrar también los volúmenes:</p>
<pre><code>docker-compose down -v
</code></pre>
<h2 id="estructura-de-la-configuración">Estructura de la configuración</h2>
<p>Veamos la configuración por partes:</p>
<pre><code class="language-yaml">version: &#39;3&#39;
</code></pre>
<p><em>Compose</em> se actualiza a menudo, con lo que el archivo de configuración va adquiriendo nuevas funcionalidades. La versión &#39;3&#39; (es una cadena, importante poner comillas) es la última y para conocer todas sus características mira la <a href="https://docs.docker.com/compose/compose-file/">página de referencia de la versión 3 de Compose</a>.</p>
<pre><code class="language-yaml">volumes:
    data:
</code></pre>
<p>Ya hemos indicado que es importante guardar los datos volátiles de las aplicaciones en volúmenes. En este caso hemos creado un volumen llamado <code>data</code>. Recordemos que <em>Compose</em> siempre añade como prefijo el nombre del directorio, con lo que el nombre real del volumen es <code>wordpress_data</code>. Podemos comprobarlo con el cliente de docker como hicimos en el capítulo de volúmenes:</p>
<pre><code class="language-console">$ docker volume ls
DRIVER              VOLUME NAME
local               wordpress_data
</code></pre>
<p>Nos saltamos la sección de redes (<em>networks</em>) y vamos a la sección de servicios, que son los contenedores que precisa o componen nuestra aplicación.</p>
<p>Primero la base de datos:</p>
<pre><code class="language-yaml">services:
    db:
        image: mariadb:10.3.9
        volumes:
            - data:/var/lib/mysql
        environment:
            - MYSQL_ROOT_PASSWORD=secret
            - MYSQL_DATABASE=wordpress
            - MYSQL_USER=manager
            - MYSQL_PASSWORD=secret
</code></pre>
<p>Después de abrir la parte de servicios, el primer nivel indica el nombre del servicio <code>db</code>, que genera el contenedor <code>wordpress_db</code>. Lo que vemos a continuación es lo mismo que hicimos en la sección anterior pero de forma parametrizada. Si recordamos, para levantar nuestra base de datos, indicamos la imagen (línea 3), luego montamos los volúmenes (línea 4), y después indicamos las variables de entorno que configuraban el contenedor (línea 6).</p>
<p>Es decir, lo anterior es equivalente, excepto por el nombre, a:</p>
<pre><code class="language-sh">$ docker run -d --name wordpress-db \
        --mount source=wordpress-db,target=/var/lib/mysql \
        -e MYSQL_ROOT_PASSWORD=secret \
        -e MYSQL_DATABASE=wordpress \
        -e MYSQL_USER=manager \
        -e MYSQL_PASSWORD=secret mariadb:10.3.9
</code></pre>
<p>Y después nuestro <em>WordPress</em>:</p>
<pre><code class="language-yaml">services:
    web:
        image: wordpress:4.9.8
        depends_on:
            - db
        volumes:
            - ./target:/var/www/html
        environment:
            - WORDPRESS_DB_USER=manager
            - WORDPRESS_DB_PASSWORD=secret
            - WORDPRESS_DB_HOST=db
        ports:
            - 8080:80
</code></pre>
<p>En este caso la equivalencia es al comando:</p>
<pre><code class="language-sh">$ docker run -d --name wordpress \
    --link wordpress-db:mysql \
    --mount type=bind,source=&quot;$(pwd)&quot;/target,target=/var/www/html \
    -e WORDPRESS_DB_USER=manager \
    -e WORDPRESS_DB_PASSWORD=secret \
    -p 8080:80 \
    wordpress:4.9.8
</code></pre>
<p>La equivalencia de los parámetros es la siguiente:</p>
<table>
<thead>
<tr>
<th>parámetro <em>Docker</em></th>
<th>parámetro <em>Composer</em></th>
</tr>
</thead>
<tbody><tr>
<td>--link</td>
<td>depends_on</td>
</tr>
<tr>
<td>--mount</td>
<td>volumes</td>
</tr>
<tr>
<td>-e</td>
<td>environment</td>
</tr>
<tr>
<td>-p, --publish</td>
<td>ports</td>
</tr>
<tr>
<td></td>
<td>image</td>
</tr>
</tbody></table>
<p>!!! note
    Si reiniciamos el ordenador, los contenedores estarán detenidos (stop), podremos reiniciarlos con <code>docker start</code> o <code>docker-compose start</code>. Este es el comportamiento predeterminado y el que nos interesa en un entorno de desarrollo.</p>
<pre><code>Sin embargo, en otros entornos, o para casos concretos, igual queremos que un contenedor tenga el mismo estado en el que estaba antes de reiniciar la máquina (iniciado o parado).

Para eso usaremos el parámetro `restart`. En el caso de la base de datos de nuestro ejemplo, la configuración quedaría como:

```yaml hl_lines=&quot;4&quot;
services:
    db:
        image: mariadb:10.3.9
        restart: unless-stopped
        volumes:
            - data:/var/lib/mysql
        environment:
            - MYSQL_ROOT_PASSWORD=secret
            - MYSQL_DATABASE=wordpress
            - MYSQL_USER=manager
            - MYSQL_PASSWORD=secret
```
El equivalente en la consola sería:

```sh hl_lines=&quot;2&quot;
$ docker run -d --name wordpress-db \
    --restart unless-stopped
    --mount source=wordpress-db,target=/var/lib/mysql \
    -e MYSQL_ROOT_PASSWORD=secret \
    -e MYSQL_DATABASE=wordpress \
    -e MYSQL_USER=manager \
    -e MYSQL_PASSWORD=secret mariadb:10.3.9
```

Otros valores son: `no` (por defecto), `always` y `on-failure`.
</code></pre>

<!--content-->

    <!-- Footer -->
    <footer class="bg-primary text-white">
        <div class="container p-4">
            <!-- Your content inside the footer -->
        </div>

        <div class="text-center p-3 d-flex justify-content-between" style="background-color: rgba(0, 0, 0, 0.2)">
            <span>© 2023 Copyright Abhijeet Singh</span>
            <a class="text-white" href="https://github.com/iamabhijeet2003">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
                </svg>
            </a>
        </div>
    </footer>

    <!-- Footer -->
</body>
</html>